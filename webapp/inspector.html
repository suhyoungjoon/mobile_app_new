<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>ì ê²€ì› - í•˜ì ì ê²€</title>
  <meta name="theme-color" content="#1e88e8" />
  <link rel="stylesheet" href="css/style.css" />
  <style>
    .inspector-header {
      background: linear-gradient(135deg, #1e88e8 0%, #1565c0 100%);
      color: white;
      padding: 16px;
      text-align: center;
    }
    .inspector-header h1 {
      margin: 0;
      font-size: 20px;
      font-weight: 700;
    }
    .inspector-header .subtitle {
      font-size: 12px;
      opacity: 0.9;
      margin-top: 4px;
    }
    .defect-card {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .defect-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .defect-card-title {
      font-weight: 700;
      font-size: 16px;
      color: #111827;
    }
    .defect-card-meta {
      font-size: 12px;
      color: #6b7280;
    }
    .defect-card-content {
      margin-bottom: 12px;
    }
    .defect-card-content .label {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 4px;
    }
    .defect-card-content .value {
      font-size: 14px;
      color: #111827;
      margin-bottom: 8px;
    }
    .inspection-badge {
      display: inline-block;
      background: #10b981;
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      margin-right: 4px;
    }
    .inspection-badge.pending {
      background: #f59e0b;
    }
    .inspection-badge.inspected {
      background: #059669;
    }
    .defect-card.has-inspected {
      border-color: #10b981;
      background: linear-gradient(to bottom, #ecfdf5 0%, white 12px);
    }
  </style>
</head>
<body>
<div class="container">
  <!-- HEADER -->
  <div class="inspector-header">
    <h1>ì ê²€ì› í•˜ì ì ê²€</h1>
    <div class="subtitle">í•˜ìëª©ë¡ ì¡°íšŒ ë° ì ê²€ê²°ê³¼ ì…ë ¥</div>
  </div>

  <div class="content">
    <!-- USER LIST (í•˜ìê°€ ë“±ë¡ëœ ì‚¬ìš©ì ëª©ë¡) -->
    <div id="user-list" class="screen hidden">
      <div class="screen-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
        <h2 style="margin: 0;">ì‚¬ìš©ì ëª©ë¡</h2>
        <button class="button ghost" onclick="onLogout()" style="width: auto; padding: 8px 12px;">ë¡œê·¸ì•„ì›ƒ</button>
      </div>
      <p style="color: #666; font-size: 14px; margin-bottom: 16px;">ì‚¬ìš©ìë³„ í•˜ìëª©ë¡ ì¡°íšŒ, ë³´ê³ ì„œ ë¯¸ë¦¬ë³´ê¸°Â·ë‹¤ìš´ë¡œë“œë¥¼ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
      <div id="user-list-container">
        <!-- ì‚¬ìš©ì ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
      </div>
    </div>

    <!-- DEFECT LIST (ì„ íƒí•œ ì‚¬ìš©ìì˜ í•˜ìëª©ë¡) -->
    <div id="defect-list" class="screen hidden">
      <div class="screen-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
        <div style="display: flex; align-items: center; gap: 8px;">
          <button class="back-btn" onclick="goBackToUserList()" style="margin: 0;">â† ì‚¬ìš©ì ëª©ë¡</button>
          <h2 id="defect-list-title" style="margin: 0;">í•˜ìëª©ë¡</h2>
        </div>
        <button class="button ghost" onclick="onLogout()" style="width: auto; padding: 8px 12px;">ë¡œê·¸ì•„ì›ƒ</button>
      </div>
      
      <div style="margin-bottom: 16px; display: flex; flex-direction: column; gap: 10px;">
        <button class="button success" onclick="onPreviewReport()" style="width: 100%;">ğŸ“„ ë³´ê³ ì„œ ë¯¸ë¦¬ë³´ê¸°</button>
        <button class="button" onclick="openDefectSelectModal()" style="width: 100%;">ğŸ“Š ì ê²€ê²°ê³¼ ì…ë ¥</button>
      </div>
      
      <div id="defect-list-container">
        <!-- í•˜ì ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
      </div>
    </div>

    <!-- REPORT (ë³´ê³ ì„œ) -->
    <div id="report" class="screen hidden">
      <div class="screen-header">
        <button class="back-btn" onclick="goBack()">â† ë’¤ë¡œ</button>
        <h2>ë³´ê³ ì„œ</h2>
        <div></div>
      </div>
      <div id="report-preview"></div>
      <div class="button-group" style="margin-top: 10px; display: flex; gap: 10px;">
        <button class="button" onclick="previewReportAsPdf()">PDF ë¯¸ë¦¬ë³´ê¸°</button>
        <button class="button" onclick="downloadReportAsPdf()">PDF ë‹¤ìš´ë¡œë“œ</button>
      </div>
    </div>

    <!-- DEFECT INSPECTION (ì ê²€ê²°ê³¼ ì…ë ¥) -->
    <div id="defect-inspection" class="screen hidden">
      <div class="screen-header">
        <button class="back-btn" onclick="goBack()">â† ë’¤ë¡œ</button>
        <h2>ì ê²€ê²°ê³¼ ì…ë ¥</h2>
        <div></div>
      </div>
      <div class="card">
        <!-- í•˜ì ì •ë³´ í‘œì‹œ -->
        <div id="defect-inspection-info" class="defect-info" style="padding: 16px; background: #f5f5f5; border-radius: 8px; margin-bottom: 16px;">
          <div class="label">í•˜ì ì •ë³´</div>
          <div id="defect-inspection-details"></div>
        </div>

        <!-- ì¸¡ì • íƒ€ì… ì„ íƒ íƒ­ -->
        <div class="equipment-tabs">
          <button class="equipment-tab active" onclick="showDefectInspectionTab('air')">ê³µê¸°ì§ˆ</button>
          <button class="equipment-tab" onclick="showDefectInspectionTab('radon')">ë¼ëˆ</button>
          <button class="equipment-tab" onclick="showDefectInspectionTab('level')">ë ˆë²¨ê¸°</button>
          <button class="equipment-tab" onclick="showDefectInspectionTab('thermal')">ì—´í™”ìƒ</button>
        </div>

        <!-- ê³µê¸°ì§ˆ íƒ­ -->
        <div id="defect-air-tab" class="equipment-tab-content">
          <div class="form-group">
            <label class="form-label">ìœ„ì¹˜</label>
            <input id="defect-air-location" class="input" placeholder="ì˜ˆ: ê±°ì‹¤, ì¹¨ì‹¤" />
          </div>
          
          <div class="form-group">
            <label class="form-label">ê³µì •</label>
            <input id="defect-air-trade" class="input" placeholder="ì˜ˆ: ë§ˆê°, ë°”ë‹¥ì¬" />
          </div>
          
          <div class="form-group">
            <label class="form-label">ê³µì • ìœ í˜• (Flush-out / Bake-out)</label>
            <select id="defect-air-process-type" class="input">
              <option value="">ì„ íƒ ì•ˆ í•¨</option>
              <option value="flush_out">Flush-out</option>
              <option value="bake_out">Bake-out</option>
            </select>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">TVOC (mg/mÂ³)</label>
              <input id="defect-air-tvoc" type="number" step="0.01" min="0" max="20" class="input" placeholder="0.00" />
            </div>
            <div class="form-group">
              <label class="form-label">HCHO (mg/mÂ³)</label>
              <input id="defect-air-hcho" type="number" step="0.01" min="0" max="20" class="input" placeholder="0.00" />
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label">CO2 (ppm)</label>
            <input id="defect-air-co2" type="number" min="0" max="10000" class="input" placeholder="400" />
          </div>
          
          <div class="form-group">
            <label class="form-label">ë©”ëª¨</label>
            <textarea id="defect-air-note" class="input" placeholder="ê³µê¸°ì§ˆ ì¸¡ì • íŠ¹ì´ì‚¬í•­"></textarea>
          </div>
          
          <div class="form-group">
            <label class="form-label">ê²°ê³¼</label>
            <select id="defect-air-result" class="input">
              <option value="normal">ì •ìƒ</option>
              <option value="check">í™•ì¸ìš”ë§</option>
              <option value="na">í•´ë‹¹ì—†ìŒ</option>
            </select>
          </div>
          
          <div class="form-group">
            <label class="form-label">ì‚¬ì§„</label>
            <div style="display: flex; gap: 8px; margin-top: 8px;">
              <input type="file" id="defect-air-photo" accept="image/*" style="display: none;" onchange="handleMeasurementPhotoUpload('air', this)" />
              <button type="button" class="button" onclick="document.getElementById('defect-air-photo').click()" style="flex: 1;">ğŸ“· ì‚¬ì§„ ì¶”ê°€</button>
              <div id="defect-air-photo-preview" style="flex: 1; min-height: 60px; border: 1px solid #ddd; border-radius: 4px; background-size: cover; background-position: center; background-repeat: no-repeat; display: none;"></div>
            </div>
          </div>
        </div>

        <!-- ë¼ëˆ íƒ­ -->
        <div id="defect-radon-tab" class="equipment-tab-content hidden">
          <div class="form-group">
            <label class="form-label">ìœ„ì¹˜</label>
            <input id="defect-radon-location" class="input" placeholder="ì˜ˆ: ì¹¨ì‹¤, ê±°ì‹¤" />
          </div>
          
          <div class="form-group">
            <label class="form-label">ê³µì •</label>
            <input id="defect-radon-trade" class="input" placeholder="ì˜ˆ: ë§ˆê°, ë°”ë‹¥ì¬" />
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">ë¼ëˆ ë†ë„</label>
              <input id="defect-radon-value" type="number" step="0.01" min="0" max="5000" class="input" placeholder="0.00" />
            </div>
            <div class="form-group">
              <label class="form-label">ë‹¨ìœ„</label>
              <select id="defect-radon-unit" class="input">
                <option value="Bq/mÂ³">Bq/mÂ³</option>
                <option value="pCi/L">pCi/L</option>
              </select>
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label">ë©”ëª¨</label>
            <textarea id="defect-radon-note" class="input" placeholder="ë¼ëˆ ì¸¡ì • íŠ¹ì´ì‚¬í•­"></textarea>
          </div>
          
          <div class="form-group">
            <label class="form-label">ê²°ê³¼</label>
            <select id="defect-radon-result" class="input">
              <option value="normal">ì •ìƒ</option>
              <option value="check">í™•ì¸ìš”ë§</option>
              <option value="na">í•´ë‹¹ì—†ìŒ</option>
            </select>
          </div>
          
          <div class="form-group">
            <label class="form-label">ì‚¬ì§„</label>
            <div style="display: flex; gap: 8px; margin-top: 8px;">
              <input type="file" id="defect-radon-photo" accept="image/*" style="display: none;" onchange="handleMeasurementPhotoUpload('radon', this)" />
              <button type="button" class="button" onclick="document.getElementById('defect-radon-photo').click()" style="flex: 1;">ğŸ“· ì‚¬ì§„ ì¶”ê°€</button>
              <div id="defect-radon-photo-preview" style="flex: 1; min-height: 60px; border: 1px solid #ddd; border-radius: 4px; background-size: cover; background-position: center; background-repeat: no-repeat; display: none;"></div>
            </div>
          </div>
        </div>

        <!-- ë ˆë²¨ê¸° íƒ­ (4 point Â±10mm, ê¸°ì¤€ 150mm) -->
        <div id="defect-level-tab" class="equipment-tab-content hidden">
          <div class="form-group">
            <label class="form-label">ìœ„ì¹˜</label>
            <input id="defect-level-location" class="input" placeholder="ì˜ˆ: ì£¼ë°©, ê±°ì‹¤" />
          </div>
          
          <div class="form-group">
            <label class="form-label">ê³µì •</label>
            <input id="defect-level-trade" class="input" placeholder="ì˜ˆ: ë°”ë‹¥, íƒ€ì¼" />
          </div>
          
          <div class="form-group">
            <label class="form-label">ê¸°ì¤€ (mm)</label>
            <input id="defect-level-reference" type="number" step="0.1" min="1" max="999" value="150" class="input" placeholder="150" />
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">1ë²ˆ ì¢Œ (mm) Â±10</label>
              <input id="defect-level-p1-left" type="number" step="0.1" min="-10" max="10" class="input" placeholder="0.0" />
            </div>
            <div class="form-group">
              <label class="form-label">1ë²ˆ ìš° (mm) Â±10</label>
              <input id="defect-level-p1-right" type="number" step="0.1" min="-10" max="10" class="input" placeholder="0.0" />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">2ë²ˆ ì¢Œ (mm) Â±10</label>
              <input id="defect-level-p2-left" type="number" step="0.1" min="-10" max="10" class="input" placeholder="0.0" />
            </div>
            <div class="form-group">
              <label class="form-label">2ë²ˆ ìš° (mm) Â±10</label>
              <input id="defect-level-p2-right" type="number" step="0.1" min="-10" max="10" class="input" placeholder="0.0" />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">3ë²ˆ ì¢Œ (mm) Â±10</label>
              <input id="defect-level-p3-left" type="number" step="0.1" min="-10" max="10" class="input" placeholder="0.0" />
            </div>
            <div class="form-group">
              <label class="form-label">3ë²ˆ ìš° (mm) Â±10</label>
              <input id="defect-level-p3-right" type="number" step="0.1" min="-10" max="10" class="input" placeholder="0.0" />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">4ë²ˆ ì¢Œ (mm) Â±10</label>
              <input id="defect-level-p4-left" type="number" step="0.1" min="-10" max="10" class="input" placeholder="0.0" />
            </div>
            <div class="form-group">
              <label class="form-label">4ë²ˆ ìš° (mm) Â±10</label>
              <input id="defect-level-p4-right" type="number" step="0.1" min="-10" max="10" class="input" placeholder="0.0" />
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label">ë©”ëª¨</label>
            <textarea id="defect-level-note" class="input" placeholder="ë ˆë²¨ê¸° ì¸¡ì • íŠ¹ì´ì‚¬í•­"></textarea>
          </div>
          
          <div class="form-group">
            <label class="form-label">ê²°ê³¼</label>
            <select id="defect-level-result" class="input">
              <option value="normal">ì´ìƒì—†ìŒ</option>
              <option value="check">í™•ì¸ìš”ë§</option>
              <option value="na">í•´ë‹¹ì—†ìŒ</option>
            </select>
          </div>
          
          <div class="form-group">
            <label class="form-label">ì‚¬ì§„</label>
            <div style="display: flex; gap: 8px; margin-top: 8px;">
              <input type="file" id="defect-level-photo" accept="image/*" style="display: none;" onchange="handleMeasurementPhotoUpload('level', this)" />
              <button type="button" class="button" onclick="document.getElementById('defect-level-photo').click()" style="flex: 1;">ğŸ“· ì‚¬ì§„ ì¶”ê°€</button>
              <div id="defect-level-photo-preview" style="flex: 1; min-height: 60px; border: 1px solid #ddd; border-radius: 4px; background-size: cover; background-position: center; background-repeat: no-repeat; display: none;"></div>
            </div>
          </div>
        </div>

        <!-- ì—´í™”ìƒ íƒ­ -->
        <div id="defect-thermal-tab" class="equipment-tab-content hidden">
          <div class="form-group">
            <label class="form-label">ìœ„ì¹˜</label>
            <input id="defect-thermal-location" class="input" placeholder="ì˜ˆ: ê±°ì‹¤, ì¹¨ì‹¤" />
          </div>
          
          <div class="form-group">
            <label class="form-label">ì‚¬ì§„</label>
            <div style="display: flex; gap: 8px; margin-top: 8px;">
              <input type="file" id="defect-thermal-photo" accept="image/*" style="display: none;" onchange="handleMeasurementPhotoUpload('thermal', this)" />
              <button type="button" class="button" onclick="document.getElementById('defect-thermal-photo').click()" style="flex: 1;">ğŸ“· ì‚¬ì§„ ì¶”ê°€</button>
              <div id="defect-thermal-photo-preview" style="flex: 1; min-height: 60px; border: 1px solid #ddd; border-radius: 4px; background-size: cover; background-position: center; background-repeat: no-repeat; display: none;"></div>
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label">ì ê²€ë‚´ìš©</label>
            <textarea id="defect-thermal-note" class="input" placeholder="ì—´í™”ìƒ ì ê²€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”" rows="4"></textarea>
          </div>
        </div>

        <!-- ì €ì¥ ë²„íŠ¼ -->
        <div class="button-group" style="margin-top: 20px;">
          <button class="button" onclick="resetDefectInspectionForm()">ì¬ì„¤ì •</button>
          <button class="button success" onclick="saveDefectInspection()">ì €ì¥</button>
        </div>
      </div>
    </div>
  </div>

  <div class="toast"></div>
</div>

<!-- í•˜ì ì„ íƒ ëª¨ë‹¬ (ì ê²€ê²°ê³¼ ì…ë ¥ ì‹œ) -->
<div id="defect-select-modal" class="modal-overlay hidden" style="position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:1000;display:none;align-items:center;justify-content:center;padding:16px;" onclick="if(event.target===this) closeDefectSelectModal()">
  <div class="card" style="max-width:400px;width:100%;max-height:80vh;overflow:auto;" onclick="event.stopPropagation()">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
      <h3 style="margin:0;">ì ê²€ê²°ê³¼ë¥¼ ì…ë ¥í•  í•˜ìë¥¼ ì„ íƒí•˜ì„¸ìš”</h3>
      <button type="button" class="button ghost" onclick="closeDefectSelectModal()" style="padding:4px 8px;">âœ•</button>
    </div>
    <div id="defect-select-modal-list"></div>
  </div>
</div>

<script src="js/api.js"></script>
<script src="js/inspector.js"></script>
<script>
  // Service Worker ë“±ë¡ ë° ìºì‹œ í´ë¦¬ì–´
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', async function(){
      try {
        // ê¸°ì¡´ Service Worker ë“±ë¡ í•´ì œ
        const registrations = await navigator.serviceWorker.getRegistrations();
        for (let registration of registrations) {
          await registration.unregister();
          console.log('ğŸ—‘ï¸ ê¸°ì¡´ Service Worker ë“±ë¡ í•´ì œ');
        }
        
        // ëª¨ë“  ìºì‹œ ì‚­ì œ
        const cacheNames = await caches.keys();
        for (let cacheName of cacheNames) {
          await caches.delete(cacheName);
          console.log('ğŸ—‘ï¸ ìºì‹œ ì‚­ì œ:', cacheName);
        }
        
        // ìƒˆ Service Worker ë“±ë¡
        const registration = await navigator.serviceWorker.register('/sw.js');
        console.log('âœ… Service Worker ë“±ë¡ ì™„ë£Œ:', registration.scope);
        
        // Service Worker ì—…ë°ì´íŠ¸ í™•ì¸
        registration.addEventListener('updatefound', () => {
          console.log('ğŸ”„ Service Worker ì—…ë°ì´íŠ¸ ë°œê²¬');
          const newWorker = registration.installing;
          newWorker.addEventListener('statechange', () => {
            if (newWorker.state === 'activated') {
              console.log('âœ… ìƒˆ Service Worker í™œì„±í™”ë¨');
              // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ ê¶Œì¥
              if (confirm('ìƒˆ ë²„ì „ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                window.location.reload();
              }
            }
          });
        });
      } catch (error) {
        console.error('âŒ Service Worker ë“±ë¡ ì‹¤íŒ¨:', error);
      }
    });
  }
</script>
</body>
</html>

