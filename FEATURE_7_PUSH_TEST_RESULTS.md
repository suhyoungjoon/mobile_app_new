# 기능 7: 푸시 알림 테스트 결과 (2025-11-10)

## 테스트 개요
- **테스트 일시**: 2025-11-10 11:00-11:04
- **프론트엔드**: https://insighti.vercel.app
- **백엔드**: https://mobile-app-new.onrender.com

## 테스트 시나리오 결과

### 1. 관리자 푸시 구독 설정
- **상태**: ❌ 실패
- **원인**: Puppeteer에서 알림 권한 요청 시 "permission denied" 에러 발생
- **해결 방법**: 
  - 관리자 계정으로 실제 브라우저에서 메인 앱에 접속하여 푸시 알림을 수동으로 활성화해야 함
  - 또는 Puppeteer의 알림 권한 설정을 개선 필요

### 2. 입주자 푸시 구독 설정
- **상태**: ✅ 성공
- **메시지**: 입주자 계정 (테스트 단지 101-1203)의 푸시 구독을 활성화했습니다.
- **스크린샷**: `07-resident-push-enabled-2025-11-10T11-03-18.png`

### 3. 푸시 알림 활성화 (메인 테스트)
- **상태**: ✅ 성공
- **메시지**: 푸시 알림을 성공적으로 활성화했습니다.
- **스크린샷**: `07-push-enabled-2025-11-10T11-03-39.png`

### 4. 테스트 알림 발송
- **상태**: ✅ 성공
- **메시지**: 테스트 알림을 발송했습니다.
- **스크린샷**: `07-test-notification-2025-11-10T11-03-46.png`

### 5. 하자 등록 알림 (관리자에게 전송)
- **상태**: ❌ 실패
- **원인**: 관리자 구독이 없어서 전송 실패 (HTTP 500)
- **해결 방법**: 관리자 계정의 푸시 구독이 활성화되면 정상 작동할 것으로 예상
- **스크린샷**: `07-defect-registered-2025-11-10T11-04-04.png`

### 6. 점검 완료 알림 (입주자에게 전송)
- **상태**: ✅ 성공
- **메시지**: ✅ 점검 완료 푸시 API 호출 성공
- **스크린샷**: `07-inspection-completed-2025-11-10T11-04-05.png`

### 7. 보고서 생성 알림 (입주자에게 전송)
- **상태**: ✅ 성공
- **메시지**: ✅ 보고서 생성 푸시 API 호출 성공
- **스크린샷**: `07-report-generated-2025-11-10T11-04-06.png`

### 8. 점검원 승인 알림 (신청 세대에게 전송)
- **상태**: ❌ 실패 (기술적 문제)
- **원인**: 이전 테스트에서 생성한 점검원 등록이 남아있어서 HTTP 409 에러 발생
- **해결**: 기존 등록 ID를 재사용하도록 테스트 스크립트 수정 완료
- **스크린샷**: `07-inspector-decision-failed-2025-11-10T11-04-07.png`

## 구현된 개선 사항

### 1. 관리자 계정 푸시 구독 지원
- `push-notifications.js`의 `/api/push/subscribe` 엔드포인트 수정
- 관리자 계정(`isAdmin: true`)의 경우 `household_id`를 NULL로 처리
- 관리자 계정은 `endpoint`만으로 UNIQUE 제약 조건 처리

### 2. 관리자 구독 조회 쿼리 개선
- 하자 등록 알림 API의 관리자 구독 조회 쿼리 수정
- `LEFT JOIN`을 사용하여 `household_id`가 NULL인 관리자 계정도 조회 가능
- `ps.user_type`을 기준으로 관리자 구독 조회

### 3. 테스트 스크립트 개선
- 관리자 계정과 입주자 계정의 푸시 구독을 자동으로 설정
- Service Worker 등록 타임아웃 및 에러 핸들링 추가
- 점검원 승인 알림 테스트에서 기존 등록 ID 재사용 로직 추가

## 남은 문제점

### 1. 관리자 푸시 구독 자동화 실패
- **문제**: Puppeteer에서 알림 권한 요청 시 "permission denied" 에러
- **임시 해결책**: 관리자 계정으로 실제 브라우저에서 수동으로 푸시 알림 활성화 필요
- **장기 해결책**: Puppeteer의 알림 권한 설정 개선 또는 다른 자동화 방법 검토

### 2. 하자 등록 알림 실패
- **원인**: 관리자 구독이 없어서 전송 실패
- **해결**: 관리자 계정의 푸시 구독이 활성화되면 자동으로 해결됨

## 권장 사항

1. **관리자 푸시 구독 설정 방법** (3가지)
   - **방법 1: 자동 활성화** (권장)
     - 관리자 페이지에 로그인하면 자동으로 푸시 알림 활성화 시도
     - 대시보드에서 상태 확인 가능
   
   - **방법 2: 대시보드에서 수동 활성화**
     - 관리자 대시보드의 "푸시 알림 설정" 카드에서 상태 확인
     - "푸시 알림 활성화" 버튼 클릭하여 수동 활성화
     - "상태 확인" 버튼으로 현재 상태 확인
   
   - **방법 3: 브라우저 설정에서 권한 허용 후 재시도**
     - 브라우저 설정에서 알림 권한을 허용한 후
     - 대시보드의 "다시 시도" 버튼 클릭

2. **데이터베이스 스키마 확인**
   - `push_subscription` 테이블에 `endpoint`에 대한 UNIQUE 인덱스가 있는지 확인
   - 관리자 계정의 경우 `household_id`가 NULL이므로 별도 인덱스 필요할 수 있음

3. **재테스트**
   - 관리자 계정의 푸시 구독을 수동으로 활성화한 후
   - 하자 등록 알림과 점검원 승인 알림 테스트 재실행

## 구현된 개선 사항 (최신)

### 1. 관리자 대시보드 푸시 알림 상태 표시
- 대시보드에 "푸시 알림 설정" 카드 추가
- 실시간 상태 표시 (활성화됨/비활성화됨/권한 필요/오류)
- 상태별 안내 메시지 및 액션 버튼 제공

### 2. 수동 활성화 기능
- "푸시 알림 활성화" 버튼으로 수동 활성화 가능
- "상태 확인" 버튼으로 현재 상태 확인
- "다시 시도" 버튼으로 실패 시 재시도 가능

### 3. 자동 활성화 개선
- 로그인 시 자동 활성화 시도
- 실패 시 대시보드에 상태 표시
- 사용자가 수동으로 활성화할 수 있는 옵션 제공

## 테스트 스크린샷 위치
`/Users/syj/Downloads/insighti_precheck_v2_enhanced/test-screenshots/feature-7-push/`

